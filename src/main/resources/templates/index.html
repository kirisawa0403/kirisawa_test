<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>
<title>なんかのサイト</title>
<link th:href="@{/css/main.css}" rel="stylesheet">
</head>
<body>
    <!-- 入力フォーム -->
    <form class="inputform" th:action="@{/input}" th:method="post" th:object="${inputTest}">
        <h5>入力フォーム</h5>

        <div class="mb-3">
            <label class="form-label w-100">
                予定名：
                <input type="text" th:field="*{title}" class="form-control">
            </label>
            <p class="text-danger" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></p>
        </div>

        <div class="mb-3">
            <label class="form-label w-100">
                日付：
                <input type="date" th:field="*{date}" class="form-control">
            </label>
            <p class="text-danger" th:if="${#fields.hasErrors('date')}" th:errors="*{date}"></p>
        </div>

        <div class="mb-3">
            <label class="form-label w-100">
                名前：
                <input type="text" th:field="*{name}" class="form-control">
            </label>
            <p class="text-danger" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></p>
        </div>

        <div class="mb-3">
            <label class="form-label w-100">
                詳細：
                <input type="text" th:field="*{detail}" class="form-control">
            </label>
            <p class="text-danger" th:if="${#fields.hasErrors('detail')}" th:errors="*{detail}"></p>
        </div>

        <div>
            <button type="submit" class="btn btn-primary">登録</button>
        </div>
    </form>

    <div class="maincont">
        <div id='calendar'></div>
    </div>

    <!-- 予定詳細モーダル -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>日付：</strong><span id="modalDate"></span></p>
            <p><strong>名前：</strong><span id="modalName"></span></p>
            <p><strong>詳細：</strong><span id="modalDetail"></span></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="editBtn">編集</button>
            <button type="button" class="btn btn-danger" id="deleteBtn">削除</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 編集モーダル -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" th:action="@{/update}" method="post" id="editForm">
            <input type="hidden" name="id" id="editId">

            <div class="mb-3">
                <label class="form-label">予定名</label>
                <input type="text" class="form-control" name="title" id="editTitle">
            </div>
            <div class="mb-3">
                <label class="form-label">日付</label>
                <input type="date" class="form-control" name="date" id="editDate">
            </div>
            <div class="mb-3">
                <label class="form-label">名前</label>
                <input type="text" class="form-control" name="name" id="editName">
            </div>
            <div class="mb-3">
                <label class="form-label">詳細</label>
                <input type="text" class="form-control" name="detail" id="editDetail">
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="submit" class="btn btn-primary">更新</button>
            </div>
        </form>
      </div>
    </div>

    <!-- JS: FullCalendar + 編集・削除処理 -->
    <script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        var events = /*[[${events}]]*/{};
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: events.map(e => ({
                id: e.id,
                title: e.title,
                start: e.date,   // YYYY-MM-DD のまま
                extendedProps: {
                    name: e.name,
                    detail: e.detail,
                    date: e.date   // 元の日付文字列を保持
                }
            })),
            eventClick: function(info) {
                // 詳細モーダルに表示
                document.getElementById('modalTitle').textContent = info.event.title;
                document.getElementById('modalDate').textContent = info.event.extendedProps.date;
                document.getElementById('modalName').textContent = info.event.extendedProps.name;
                document.getElementById('modalDetail').textContent = info.event.extendedProps.detail;

                // id を保持
                document.getElementById('editBtn').setAttribute('data-id', info.event.id);
                document.getElementById('deleteBtn').setAttribute('data-id', info.event.id);

                var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
                eventModal.show();
            }
        });

        calendar.render();

        // 編集ボタン
        document.getElementById('editBtn').onclick = function() {
            var id = this.getAttribute('data-id');
            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();

            document.getElementById('editId').value = id || "";

            document.getElementById('editTitle').value = document.getElementById('modalTitle').textContent;
            // 日付は文字列をそのままセット
            document.getElementById('editDate').value = document.getElementById('modalDate').textContent;
            document.getElementById('editName').value = document.getElementById('modalName').textContent;
            document.getElementById('editDetail').value = document.getElementById('modalDetail').textContent;

            var editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        };

        // 削除ボタン
        document.getElementById('deleteBtn').onclick = function() {
            var id = this.getAttribute('data-id');
            if (id) {
                if(confirm('本当に削除しますか？')) {
                    var form = document.createElement("form");
                    form.method = "post";
                    form.action = /*[[@{/delete}]]*/ "/delete";

                    var input = document.createElement("input");
                    input.type = "hidden";
                    input.name = "id";
                    input.value = id;
                    form.appendChild(input);

                    document.body.appendChild(form);
                    form.submit();
                }
            }
        };
    });
    /*]]>*/
    </script>
</body>
</html>